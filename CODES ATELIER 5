import com.google.gson;
import com.google.gson.GsonBuilder;
import com.google.gson.reflect.TypeToken;
import java.io.*;
import java.lang.reflect.Type;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;
import java.util.Optional;
import java.io.Serializable;

abstract class Compte implements Serializable {
    private static final long serialVersionUID = 1L;

    private String numeroCompte;
    private double solde;
    private String titulaire;
    private String codePIN;

    public Compte(String titulaire, String codePIN) {
        this.numeroCompte = UUID.randomUUID().toString().substring(0, 8);
        this.solde = 0.0;
        this.titulaire = titulaire;
        this.codePIN = codePIN;
    }

    public abstract String getTypeCompte();

    public String getNumeroCompte() { return numeroCompte; }
    public double getSolde() { return solde; }
    public String getTitulaire() { return titulaire; }
    public String getCodePIN() { return codePIN; }

    public void setSolde(double solde) { this.solde = solde; }
    public void setCodePIN(String codePIN) { this.codePIN = codePIN; }

    public boolean verifierPIN(String pin) {
        return this.codePIN.equals(pin);
    }

    public void deposer(double montant) {
        if (montant > 0) {
            this.solde += montant;
        }
    }

    public boolean retirer(double montant) {
        if (montant > 0 && this.solde >= montant) {
            this.solde -= montant;
            return true;
        }
        return false;
    }
}

class CompteAirtelMoney extends Compte {
    private static final long serialVersionUID = 1L;

    private String numeroTelephone;

    public CompteAirtelMoney(String titulaire, String codePIN, String numeroTelephone) {
        super(titulaire, codePIN);
        this.numeroTelephone = numeroTelephone;
    }

    @Override
    public String getTypeCompte() {
        return "Airtel Money";
    }

    public String getNumeroTelephone() { return numeroTelephone; }
    public void setNumeroTelephone(String numeroTelephone) { this.numeroTelephone = numeroTelephone; }

    @Override
    public String toString() {
        return String.format("ID: %s | Tél: %s | Titulaire: %s | Solde: %.2f $",
                getNumeroCompte(), numeroTelephone, getTitulaire(), getSolde());
    }
}

class GestionnaireFichierJSON {
    private static final String NOM_FICHIER = "comptes_airtel.json";
    private final Gson gson = new GsonBuilder().setPrettyPrinting().create();
    private final Type LIST_TYPE = new TypeToken<ArrayList<CompteAirtelMoney>>() {}.getType();

    public List<CompteAirtelMoney> lireFichier() {
        try (Reader reader = new FileReader(NOM_FICHIER)) {
            List<CompteAirtelMoney> comptes = gson.fromJson(reader, LIST_TYPE);
            return (comptes != null) ? comptes : new ArrayList<>();
        } catch (FileNotFoundException e) {
            return new ArrayList<>();
        } catch (IOException e) {
            System.err.println("Erreur de lecture du fichier JSON: " + e.getMessage());
            return new ArrayList<>();
        }
    }

    public void ecrireFichier(List<CompteAirtelMoney> comptes) throws IOException {
        try (FileWriter writer = new FileWriter(NOM_FICHIER)) {
            gson.toJson(comptes, writer);
        }
    }

    public void creerCompte(CompteAirtelMoney nouveauCompte) {
        List<CompteAirtelMoney> comptes = lireFichier();
        boolean existe = comptes.stream()
                .anyMatch(c -> c.getNumeroTelephone().equals(nouveauCompte.getNumeroTelephone()));

        if (!existe) {
            comptes.add(nouveauCompte);
            try {
                ecrireFichier(comptes);
                System.out.println(" Compte créé et ajouté au fichier JSON.");
            } catch (IOException e) {
                System.err.println("Erreur lors de l'écriture du fichier JSON.");
            }
        } else {
            System.out.println("❌Un compte existe déjà avec ce numéro de téléphone.");
        }
    }

    public Optional<CompteAirtelMoney> lireCompteParTelephone(String numeroTelephone) {
        List<CompteAirtelMoney> comptes = lireFichier();
        return comptes.stream()
                .filter(c -> c.getNumeroTelephone().equals(numeroTelephone))
                .findFirst();
    }

    public void afficherTousLesComptes() {
        List<CompteAirtelMoney> comptes = lireFichier();
        if (comptes.isEmpty()) {
            System.out.println("Aucun compte trouvé dans le fichier JSON.");
            return;
        }
        System.out.println("\n--- [READ] Liste des Comptes Airtel Money ---");
        comptes.forEach(System.out::println);
    }

    public boolean mettreAJourCompte(String numeroTelephone, String nouveauTitulaire, String nouveauPIN) {
        List<CompteAirtelMoney> comptes = lireFichier();

        Optional<CompteAirtelMoney> compteOpt = comptes.stream()
                .filter(c -> c.getNumeroTelephone().equals(numeroTelephone))
                .findFirst();

        if (compteOpt.isPresent()) {
            CompteAirtelMoney compteAModifier = compteOpt.get();
            if (nouveauPIN != null && !nouveauPIN.isEmpty()) {
                compteAModifier.setCodePIN(nouveauPIN);
            }

            try {
                ecrireFichier(comptes);
                System.out.println(" Compte " + numeroTelephone + " mis à jour (PIN/Titulaire).");
                return true;
            } catch (IOException e) {
                System.err.println("Erreur lors de l'enregistrement de la modification.");
                return false;
            }
        }
        System.out.println("Compte non trouvé pour la modification.");
        return false;
    }

    public boolean supprimerCompte(String numeroTelephone) {
        List<CompteAirtelMoney> comptes = lireFichier();
        boolean supprime = comptes.removeIf(c -> c.getNumeroTelephone().equals(numeroTelephone));

        if (supprime) {
            try {
                ecrireFichier(comptes);
                System.out.println(" Compte JSON " + numeroTelephone + " supprimé.");
                return true;
            } catch (IOException e) {
                System.err.println("Erreur lors de la suppression du fichier JSON.");
                return false;
            }
        } else {
            System.out.println("Compte non trouvé pour la suppression.");
            return false;
        }
    }
}

public class AirtelMoneyCRUD {
    public static void main(String[] args) {
        GestionnaireFichierJSON crudManager = new GestionnaireFichierJSON();

        System.out.println("\n--- Opération CREATE ---");
        CompteAirtelMoney sarah = new CompteAirtelMoney("Sarah MBUYU", "1234", "0992929456");
        sarah.deposer(500.0);
        crudManager.creerCompte(sarah);

        CompteAirtelMoney jean = new CompteAirtelMoney("Jean Paul MPOLO", "4321", "0977152825");
        jean.deposer(150.0);
        crudManager.creerCompte(jean);

        System.out.println("\n--- Opération READ ---");
        crudManager.afficherTousLesComptes();

        Optional<CompteAirtelMoney> compteSarah = crudManager.lireCompteParTelephone("0992929456");
        if (compteSarah.isPresent()) {
            System.out.println("Lecture spécifique (Sarah): " + compteSarah.get());
        }

        System.out.println("\n--- Opération UPDATE ---");
        crudManager.mettreAJourCompte("0977152825", null, "9999");

        Optional<CompteAirtelMoney> compteJean = crudManager.lireCompteParTelephone("0977152825");
        if (compteJean.isPresent() && compteJean.get().verifierPIN("9999")) {
            System.out.println("Solde Jean Paul avant retrait: " + compteJean.get().getSolde());
            if (compteJean.get().retirer(50.0)) {
                System.out.println("Retrait de 50.0 $ effectué.");
                List<CompteAirtelMoney> tousLesComptes = crudManager.lireFichier();
                tousLesComptes.replaceAll(c -> c.getNumeroTelephone().equals("0977152825") ? compteJean.get() : c);
                try {
                    crudManager.ecrireFichier(tousLesComptes);
                    System.out.println("Transaction enregistrée (nouvel état écrit en JSON).");
                } catch (IOException e) { e.printStackTrace(); }
            }
        }
        crudManager.afficherTousLesComptes();


        System.out.println("\n--- Opération DELETE ---");
        crudManager.supprimerCompte("0992929456");

        System.out.println("\n--- Vérification après DELETE ---");
        crudManager.afficherTousLesComptes();
    }
}
